<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>师生管理平台</title>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js'></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #fff; color: #000; }

    /* 登录界面 */
    .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5f5; }
    .login-box { background: white; padding: 40px; border: 1px solid #ddd; border-radius: 8px; width: 350px; text-align: center; }
    .login-box h1 { margin-bottom: 20px; font-size: 24px; }
    
    /* 🟢 新增：连接状态指示器 */
    .connection-status { 
      margin-bottom: 20px; 
      padding: 10px; 
      border-radius: 6px; 
      font-size: 12px; 
      text-align: center;
      transition: all 0.3s ease;
    }
    .status-checking { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .status-online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    /* 🟢 新增：状态指示灯 */
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }
    .indicator-checking { background: #ffc107; }
    .indicator-online { background: #28a745; }
    .indicator-offline { background: #dc3545; }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* 🟢 新增：详细状态信息 */
    .status-details {
      font-size: 10px;
      margin-top: 5px;
      padding: 5px;
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
      display: none;
    }
    .status-details.show { display: block; }
    
    .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .login-box button { width: 100%; padding: 10px; background: #000; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; margin-top: 10px; transition: all 0.3s ease; }
    .login-box button:hover { background: #333; }
    .login-box button:disabled { background: #ccc; cursor: not-allowed; }
    
    /* 🟢 新增：登录过程指示 */
    .login-progress {
      display: none;
      margin-top: 10px;
      padding: 8px;
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 4px;
      font-size: 12px;
    }
    .login-progress.show { display: block; }
    
    .progress-step {
      display: flex;
      align-items: center;
      margin: 3px 0;
      font-size: 11px;
    }
    .step-icon {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .step-pending { background: #ffc107; }
    .step-success { background: #28a745; }
    .step-error { background: #dc3545; }
    .step-loading {
      background: #007bff;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message { color: red; margin-top: 10px; font-size: 12px; }
    .success-message { color: green; margin-top: 10px; font-size: 12px; }
    .link-text { color: #007bff; cursor: pointer; text-decoration: underline; font-size: 12px; margin-top: 15px; }
    .link-text:hover { color: #0056b3; }

    /* 🟢 新增：重试按钮 */
    .retry-button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
      margin-top: 5px;
    }
    .retry-button:hover { background: #5a6268; }

    /* 主界面 */
    .main-app { display: none; }

    /* 顶部导航 */
    .header { background: #f5f5f5; padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 20px; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-info span { font-size: 14px; }
    .logout-btn { padding: 5px 10px; border: 1px solid #999; background: #fff; cursor: pointer; border-radius: 4px; font-size: 12px; }

    /* 标签导航 */
    .nav-tabs { display: flex; border-bottom: 1px solid #ddd; background: #f9f9f9; }
    .nav-tab { padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; }
    .nav-tab.active { border-bottom-color: #000; background: #fff; }

    /* 主要布局 */
    .main-container { display: flex; height: calc(100vh - 120px); }
    .content-panel { flex: 1; padding: 20px; display: none; overflow-y: auto; display: flex;flex-direction: column;overflow: hidden; }
    .calendar-main {flex: 1;min-height: 0;display: flex;flex-direction: column;}
    #mainCalendar {flex: 1;min-height: 0;}
    .content-panel.active { display: block; }

    /* 日历布局 */
    .calendar-layout { display: flex; gap: 20px; height: 100%; }
    .calendar-sidebar { width: 250px; border: 1px solid #ddd; padding: 15px; }
    .calendar-main { flex: 1; border: 1px solid #ddd; padding: 15px; }

    .sidebar-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .sidebar-section:last-child { border-bottom: none; }
    .sidebar-section h3 { margin-bottom: 10px; font-size: 14px; }

    /* 统计网格 */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .stat-item { text-align: center; padding: 8px; border: 1px solid #ddd; }
    .stat-number { font-size: 16px; font-weight: bold; }
    .stat-label { font-size: 11px; margin-top: 2px; }

    /* 功能按钮 */
    .function-buttons { display: flex; flex-direction: column; gap: 8px; }
    .function-btn { padding: 8px 12px; border: 1px solid #999; background: #f5f5f5; cursor: pointer; text-align: center; font-size: 12px; }
    .function-btn:hover { background: #eee; }

    /* 数据分析页面 */
    .filter-panel { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; }
    .filter-section { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .filter-section:last-child { border-bottom: none; }
    .filter-section h3 { margin-bottom: 10px; font-size: 14px; }

    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .filter-item { display: flex; flex-direction: column; }
    .filter-item label { margin-bottom: 3px; font-size: 12px; }
    .filter-item select, .filter-item input { padding: 5px; border: 1px solid #999; font-size: 12px; }

    /* 学生列表 */
    .student-list { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    .student-item { display: flex; align-items: center; gap: 8px; padding: 5px; border-bottom: 1px solid #eee; }
    .student-item:last-child { border-bottom: none; }
    .student-item input { margin: 0; }
    .student-item label { margin: 0; cursor: pointer; font-size: 12px; flex: 1; }
    .student-item.selected { background: #f0f0f0; }

    /* 按钮样式 */
    .btn { padding: 8px 16px; border: 1px solid #999; background: #f5f5f5; cursor: pointer; font-size: 12px; }
    .btn:hover { background: #eee; }
    .btn-primary { background: #000; color: #fff; }
    .btn-primary:hover { background: #333; }

    .action-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }

    /* 结果展示 */
    .results-panel { border: 1px solid #ddd; margin-top: 20px; display: none; }
    .results-header { background: #f5f5f5; padding: 10px; border-bottom: 1px solid #ddd; }
    .results-content { padding: 15px; }

    .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    .data-table th, .data-table td { padding: 6px; border: 1px solid #ddd; text-align: left; font-size: 11px; }
    .data-table th { background: #f5f5f5; font-weight: bold; }

    .copy-area { background: #f9f9f9; border: 1px solid #ddd; padding: 10px; font-family: monospace; font-size: 10px; max-height: 200px; overflow-y: auto; margin-top: 10px; }

    /* 用户详情页面 */
    .user-profile { max-width: 600px; }
    .profile-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; }
    .profile-section h3 { margin-bottom: 10px; font-size: 14px; }
    .profile-item { display: flex; margin-bottom: 8px; }
    .profile-item label { min-width: 120px; font-weight: bold; font-size: 12px; }
    .profile-item span { font-size: 12px; }

    /* 加载动画 */
    .loading { text-align: center; padding: 20px; }
    .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #999; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto 10px; }

    /* 小日历样式 */
    .mini-calendar .fc { font-size: 10px; }
    .mini-calendar .fc-button { padding: 2px 4px; font-size: 9px; }
    .mini-calendar .fc-daygrid-day { height: 20px; }
    .mini-calendar .fc-daygrid-day-number { font-size: 9px; }
    .mini-calendar .fc-event { font-size: 6px; height: 2px; }

    /* 响应式 */
    @media (max-width: 768px) {
      .calendar-layout { flex-direction: column; }
      .calendar-sidebar { width: 100%; }
      .filter-grid { grid-template-columns: 1fr; }
    }

    /* 隐藏FullCalendar默认工具栏 */
    .fc-toolbar { display: none; }
    .fc-toolbar.show { display: flex; }
  </style>
</head>
<body>
  <!-- 登录界面 -->
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <h1>师生管理平台</h1>

      <!-- 🟢 新增：连接状态显示区域 -->
      <div id="connectionStatus" class="connection-status status-checking">
        <span class="status-indicator indicator-checking"></span>
        <span id="statusText">正在检测服务器连接...</span>
        <div id="statusDetails" class="status-details">
          <div>正在连接到后台服务...</div>
        </div>
        <button id="retryConnection" class="retry-button" style="display: none;">重试连接</button>
      </div>

      <!-- 登录表单 -->
      <div id="loginForm">
        <input type="text" id="loginUsername" placeholder="用户名（由老师分配）" />
        <button type="button" id="loginBtn" disabled>登录</button>
        
        <!-- 🟢 新增：登录过程指示 -->
        <div id="loginProgress" class="login-progress">
          <div class="progress-step">
            <span id="stepVerify" class="step-icon step-pending"></span>
            <span>验证用户名...</span>
          </div>
          <div class="progress-step">
            <span id="stepConnect" class="step-icon step-pending"></span>
            <span>连接用户数据...</span>
          </div>
          <div class="progress-step">
            <span id="stepLoad" class="step-icon step-pending"></span>
            <span>加载个人信息...</span>
          </div>
        </div>
        
        <div class="link-text" id="showRegisterBtn">还没有账号？登记信息</div>
        <div id="loginError" class="error-message"></div>
      </div>

      <!-- 注册表单 -->
      <div id="registerForm" style="display: none;">
        <input type="text" id="registerName" placeholder="姓名" />
        <input type="email" id="registerEmail" placeholder="邮箱（用于区分同名，不对外公开）" />

        <select id="registerDepartment">
          <option value="">选择所属部门</option>
          <option value="文科大学院">文科大学院</option>
          <option value="理科大学院">理科大学院</option>
          <option value="其他">其他</option>
        </select>

        <input type="text" id="registerMajor" placeholder="专业" />

        <select id="registerRole">
          <option value="">选择身份</option>
          <option value="学生">学生</option>
          <option value="老师">老师</option>
        </select>

        <button type="button" id="registerBtn">登记</button>

        <div class="link-text" id="showLoginBtn">已有账号？返回登录</div>
        <div id="registerError" class="error-message"></div>
      </div>
    </div>
  </div>

  <!-- 主应用界面（保持不变） -->
  <div id="mainApp" class="main-app">
    <div class="header">
      <h1>师生管理平台</h1>
      <div class="user-info">
        <span id="userGreeting">欢迎，</span>
        <span id="userRole"></span>
        <button class="logout-btn" id="logoutBtn">退出</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="calendar">日历视图</button>
      <button class="nav-tab" data-tab="analysis" id="analysisTab">数据分析</button>
      <button class="nav-tab" data-tab="profile">个人信息</button>
    </div>

    <div class="main-container">
      <!-- 日历页面 -->
      <div class="content-panel active" id="calendarPanel">
        <div class="calendar-layout">
          <div class="calendar-sidebar">
            <div class="sidebar-section">
              <h3>小日历</h3>
              <div id="miniCalendar" class="mini-calendar"></div>
            </div>

            <div class="sidebar-section">
              <h3>今日概览</h3>
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-number" id="todayCourses">0</div>
                  <div class="stat-label">课程</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="todayConsultations">0</div>
                  <div class="stat-label">面谈</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="todayReminders">0</div>
                  <div class="stat-label">提醒</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="attendanceRate">0%</div>
                  <div class="stat-label">出勤率</div>
                </div>
              </div>
            </div>

            <div class="sidebar-section">
              <div class="sidebar-section" id="publishPanel" style="display:none;">
                <h3>老师登记</h3>
                <div class="filter-item">
                  <label>课程属性</label>
                  <select id="pubAttr">
                    <option value="大课">大课（只读）</option>
                    <option value="VIP">VIP（可约）</option>
                    <option value="面谈">面谈（可约）</option>
                  </select>
                </div>
                <div class="filter-item">
                  <label>课程名（大课必填）</label>
                  <input type="text" id="pubCourseName" />
                </div>
                <div class="filter-item">
                  <label>模式</label>
                  <select id="pubMode">
                    <option value="single">单次</option>
                    <option value="range">区间+周几</option>
                  </select>
                </div>
                <div class="filter-item" id="singleDateRow">
                  <label>日期</label>
                  <input type="date" id="pubDate" />
                </div>
                <div class="filter-item" id="rangeRows" style="display:none;">
                  <label>起止日期</label>
                  <div style="display:flex;gap:6px;">
                    <input type="date" id="pubStartDate" />
                    <input type="date" id="pubEndDate" />
                  </div>
                  <label style="margin-top:6px;">周几（可多选）</label>
                  <div>
                    <label><input type="checkbox" class="wd" value="1">周一</label>
                    <label><input type="checkbox" class="wd" value="2">周二</label>
                    <label><input type="checkbox" class="wd" value="3">周三</label>
                    <label><input type="checkbox" class="wd" value="4">周四</label>
                    <label><input type="checkbox" class="wd" value="5">周五</label>
                    <label><input type="checkbox" class="wd" value="6">周六</label>
                    <label><input type="checkbox" class="wd" value="0">周日</label>
                  </div>
                  <label style="margin-top:6px;">回数（可选）</label>
                  <input type="number" id="pubCount" min="1" placeholder="不填则按区间+周几全部展开" />
                </div>
                <div class="filter-item">
                  <label>时间（开始-结束）</label>
                  <div style="display:flex;gap:6px;">
                    <input type="time" id="pubStartTime" value="09:00" />
                    <input type="time" id="pubEndTime" value="10:00" />
                  </div>
                  <div style="font-size:11px;color:#666;">仅允许整点或半点（:00 / :30）</div>
                </div>
                <div class="filter-item">
                  <label>面向专业（逗号分隔；空=全专业）</label>
                  <input type="text" id="pubMajors" placeholder="例：文科研究科,工学研究科" />
                </div>
                <div class="filter-item">
                  <label>可见学生IDs（逗号分隔；VIP/面谈用）</label>
                  <input type="text" id="pubVisibleIds" placeholder="例：S001,S015" />
                </div>
                <button class="btn btn-primary" id="pubSubmitBtn">发布</button>
              </div>

              <div class="function-buttons">
                <button class="function-btn" id="refreshDataBtn">刷新数据</button>
                <button class="function-btn" id="analysisBtn">数据分析</button>
                <button class="function-btn" id="profileBtn">个人信息</button>
                <button class="function-btn" id="helpBtn">使用帮助</button>
              </div>
            </div>
          </div>

          <div class="calendar-main">
            <div id="mainCalendar"></div>
          </div>
        </div>
      </div>

      <!-- 其他页面保持不变... -->
      <div class="content-panel" id="analysisPanel">
        <!-- 数据分析页面内容 -->
      </div>

      <div class="content-panel" id="profilePanel">
        <!-- 个人信息页面内容 -->
      </div>
    </div>
  </div>

  <script>
    // ========== 全局变量 ==========
    const API_URL = 'https://script.google.com/macros/s/AKfycbxJw_3N3fDwCOzgixIXXgSahTho-s-H_M8-hdQhDK09vSxp6-WgX6CztXbVph1vemmq/exec';
    let currentUser = null;
    let allStudents = [];
    let selectedStudents = [];
    let mainCalendar, miniCalendar;
    let connectionCheckInterval;

    // ========== 🟢 新增：连接状态管理 ==========
    class ConnectionMonitor {
      constructor() {
        this.status = 'checking';
        this.lastCheck = null;
        this.retryCount = 0;
        this.maxRetries = 3;
      }

      async checkConnection() {
        this.updateStatus('checking', '正在检测服务器连接...');
        
        try {
          const startTime = Date.now();
          const result = await this.callAPIWithTimeout('testConnection', {}, 10000);
          const responseTime = Date.now() - startTime;
          
          if (result && result.success) {
            this.updateStatus('online', '✅ 服务器连接正常', {
              userCount: result.userCount || 0,
              responseTime: responseTime,
              spreadsheetName: result.spreadsheetName,
              timestamp: result.timestamp
            });
            this.retryCount = 0;
            this.enableLogin();
          } else {
            throw new Error(result?.message || '服务器响应异常');
          }
        } catch (error) {
          this.retryCount++;
          console.error('连接检测失败:', error);
          
          if (this.retryCount < this.maxRetries) {
            this.updateStatus('error', `❌ 连接失败，正在重试 (${this.retryCount}/${this.maxRetries})...`, {
              error: error.message,
              retrying: true
            });
            setTimeout(() => this.checkConnection(), 2000);
          } else {
            this.updateStatus('offline', '❌ 服务器连接失败', {
              error: error.message,
              canRetry: true
            });
            this.showRetryButton();
          }
        }
      }

      async callAPIWithTimeout(action, params, timeout) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
          const formData = new URLSearchParams();
          formData.append('action', action);
          formData.append('params', JSON.stringify(params));

          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData,
            mode: 'cors',
            signal: controller.signal
          });

          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const text = await response.text();
          let cleanText = text.trim();
          const jsonStart = cleanText.indexOf('{');
          const jsonEnd = cleanText.lastIndexOf('}');
          
          if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
            cleanText = cleanText.substring(jsonStart, jsonEnd + 1);
          }
          
          return JSON.parse(cleanText);
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('请求超时，请检查网络连接');
          }
          throw error;
        }
      }

      updateStatus(status, message, details = {}) {
        this.status = status;
        this.lastCheck = new Date();
        
        const statusEl = document.getElementById('connectionStatus');
        const textEl = document.getElementById('statusText');
        const detailsEl = document.getElementById('statusDetails');
        const indicatorEl = statusEl.querySelector('.status-indicator');

        // 更新状态样式
        statusEl.className = `connection-status status-${status}`;
        indicatorEl.className = `status-indicator indicator-${status}`;
        textEl.textContent = message;

        // 更新详细信息
        if (details && Object.keys(details).length > 0) {
          let detailsHTML = '';
          
          if (details.spreadsheetName) {
            detailsHTML += `<div>📊 表格: ${details.spreadsheetName}</div>`;
          }
          if (details.userCount !== undefined) {
            detailsHTML += `<div>👥 用户数: ${details.userCount}</div>`;
          }
          if (details.responseTime) {
            detailsHTML += `<div>⚡ 响应时间: ${details.responseTime}ms</div>`;
          }
          if (details.timestamp) {
            detailsHTML += `<div>🕐 检测时间: ${new Date(details.timestamp).toLocaleString()}</div>`;
          }
          if (details.error) {
            detailsHTML += `<div>❌ 错误: ${details.error}</div>`;
          }
          
          if (detailsHTML) {
            detailsEl.innerHTML = detailsHTML;
            detailsEl.classList.add('show');
          }
        } else {
          detailsEl.classList.remove('show');
        }
      }

      enableLogin() {
        const loginBtn = document.getElementById('loginBtn');
        loginBtn.disabled = false;
        loginBtn.textContent = '登录';
      }

      disableLogin() {
        const loginBtn = document.getElementById('loginBtn');
        loginBtn.disabled = true;
        loginBtn.textContent = '服务器离线';
      }

      showRetryButton() {
        const retryBtn = document.getElementById('retryConnection');
        retryBtn.style.display = 'inline-block';
        this.disableLogin();
      }

      hideRetryButton() {
        const retryBtn = document.getElementById('retryConnection');
        retryBtn.style.display = 'none';
      }

      retry() {
        this.retryCount = 0;
        this.hideRetryButton();
        this.checkConnection();
      }
    }

    // 创建连接监控实例
    const connectionMonitor = new ConnectionMonitor();

    // ========== 🟢 新增：增强的API调用函数 ==========
    async function callAPI(action, params = {}) {
      try {
        return await connectionMonitor.callAPIWithTimeout(action, params, 15000);
      } catch (error) {
        console.error('API调用失败:', error);
        return { success: false, message: '网络请求失败: ' + error.message };
      }
    }

    // ========== 🟢 新增：登录过程可视化 ==========
    function showLoginProgress() {
      const progressEl = document.getElementById('loginProgress');
      progressEl.classList.add('show');
      
      // 重置所有步骤
      document.getElementById('stepVerify').className = 'step-icon step-pending';
      document.getElementById('stepConnect').className = 'step-icon step-pending';
      document.getElementById('stepLoad').className = 'step-icon step-pending';
    }

    function updateLoginStep(step, status) {
      const stepEl = document.getElementById(`step${step}`);
      stepEl.className = `step-icon step-${status}`;
    }

    function hideLoginProgress() {
      const progressEl = document.getElementById('loginProgress');
      progressEl.classList.remove('show');
    }

    // ========== 界面切换 ==========
    function showRegisterForm() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
      clearMessages();
    }

    function showLoginForm() {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      clearMessages();
    }

    function clearMessages() {
      document.getElementById('loginError').textContent = '';
      document.getElementById('registerError').textContent = '';
      hideLoginProgress();
    }

    // ========== 🟢 增强的登录函数 ==========
    async function login() {
      const username = (document.getElementById('loginUsername').value || '').trim();
      const errorDiv = document.getElementById('loginError');

      if (!username) {
        errorDiv.textContent = '请输入用户名';
        return;
      }

      // 检查连接状态
      if (connectionMonitor.status !== 'online') {
        errorDiv.textContent = '服务器连接异常，请等待连接恢复后重试';
        return;
      }

      // 显示登录过程
      showLoginProgress();
      errorDiv.textContent = '';
      
      // 禁用登录按钮
      const loginBtn = document.getElementById('loginBtn');
      loginBtn.disabled = true;
      loginBtn.textContent = '登录中...';

      try {
        // 步骤1：验证用户名
        updateLoginStep('Verify', 'loading');
        await new Promise(resolve => setTimeout(resolve, 500)); // 视觉效果

        const result = await callAPI('loginByUsername', { username });

        if (!result || !result.success) {
          updateLoginStep('Verify', 'error');
          throw new Error((result && result.message) || '用户名不存在');
        }

        updateLoginStep('Verify', 'success');

        // 步骤2：连接用户数据
        updateLoginStep('Connect', 'loading');
        await new Promise(resolve => setTimeout(resolve, 300));

        currentUser = result.user || {};
        currentUser.userId = currentUser.username || username;

        updateLoginStep('Connect', 'success');

        // 步骤3：加载个人信息
        updateLoginStep('Load', 'loading');
        await new Promise(resolve => setTimeout(resolve, 300));

        // 进入主应用
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';

        updateLoginStep('Load', 'success');

        // 初始化应用
        updateUserInterface();
        initializeCalendars();
        loadUserData();

        hideLoginProgress();

      } catch (error) {
        console.error('登录失败:', error);
        errorDiv.textContent = error.message || '登录失败，请重试';
        hideLoginProgress();
      } finally {
        // 恢复登录按钮
        loginBtn.disabled = false;
        loginBtn.textContent = '登录';
      }
    }

    // ========== 🟢 增强的注册函数 ==========
    async function register() {
      const name = (document.getElementById('registerName').value || '').trim();
      const email = (document.getElementById('registerEmail').value || '').trim();
      const department = document.getElementById('registerDepartment').value;
      const major = (document.getElementById('registerMajor').value || '').trim();
      const role = document.getElementById('registerRole').value;
      const errorDiv = document.getElementById('registerError');

      if (!name || !email || !department || !major || !role) {
        errorDiv.textContent = '请填写所有必填字段';
        return;
      }

      // 检查连接状态
      if (connectionMonitor.status !== 'online') {
        errorDiv.textContent = '服务器连接异常，请等待连接恢复后重试';
        return;
      }

      const registerBtn = document.getElementById('registerBtn');
      registerBtn.disabled = true;
      registerBtn.textContent = '登记中...';
      errorDiv.textContent = '正在提交登记信息...';
      errorDiv.style.color = '#007bff';

      try {
        const result = await callAPI('registerByProfile', { name, email, department, major, role });

        if (result && result.success) {
          errorDiv.style.color = 'green';
          errorDiv.textContent = '✅ 登记成功！请联系老师获取您的"用户名"，之后使用用户名登录。';

          // 清空注册表单
          document.getElementById('registerName').value = '';
          document.getElementById('registerEmail').value = '';
          document.getElementById('registerDepartment').value = '';
          document.getElementById('registerMajor').value = '';
          document.getElementById('registerRole').value = '';

          // 3秒后回到登录
          setTimeout(() => {
            showLoginForm();
          }, 3000);
        } else {
          throw new Error((result && result.message) || '登记失败');
        }
      } catch (error) {
        console.error('注册失败:', error);
        errorDiv.style.color = 'red';
        errorDiv.textContent = '❌ ' + error.message;
      } finally {
        registerBtn.disabled = false;
        registerBtn.textContent = '登记';
      }
    }

    // ========== 退出登录 ==========
    function logout() {
      currentUser = null;
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('loginUsername').value = '';
      clearMessages();
      
      // 重新检查连接状态
      connectionMonitor.checkConnection();
    }

    // ========== 用户界面更新 ==========
    function updateUserInterface() {
      if (!currentUser) return;
      document.getElementById('userGreeting').textContent = `欢迎，${currentUser.name}`;
      document.getElementById('userRole').textContent = `(${currentUser.role})`;

      const analysisTab = document.getElementById('analysisTab');
      const analysisBtn = document.getElementById('analysisBtn');
      const isTeacher = (currentUser.role === '老师' || String(currentUser.userId).startsWith('T'));
      const isAdmin = String(currentUser.userId).startsWith('A');

      if (isTeacher || isAdmin) {
        analysisTab.style.display = 'block';
        analysisBtn.style.display = 'block';
        document.getElementById('publishPanel').style.display = 'block';
      } else {
        analysisTab.style.display = 'none';
        analysisBtn.style.display = 'none';
        document.getElementById('publishPanel').style.display = 'none';
      }
    }

    // ========== 日历相关 ==========
    function initializeCalendars() {
      const miniCalendarEl = document.getElementById('miniCalendar');
      miniCalendar = new FullCalendar.Calendar(miniCalendarEl, {
        initialView: 'dayGridMonth',
        locale: 'zh-cn',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        height: 'auto',
        events: [],
        slotMinTime: '09:00:00',
        slotMaxTime: '21:00:00',
        expandRows: true,
        dateClick: function(info) { 
          if (mainCalendar) mainCalendar.gotoDate(info.dateStr); 
        }
      });

      const mainCalendarEl = document.getElementById('mainCalendar');
      mainCalendar = new FullCalendar.Calendar(mainCalendarEl, {
        initialView: 'timeGridWeek',
        locale: 'zh-cn',
        headerToolbar: { left: 'prev,next', center: 'title', right: 'today,timeGridWeek,timeGridDay' },
        buttonText: { today: '今天', week: '周', day: '日' },
        height: 'auto',
        events: [],
        allDaySlot: false,
        slotMinTime: '09:00:00',
        slotMaxTime: '21:00:00',
        slotDuration: '00:30:00',
        slotLabelInterval: '01:00:00',
        scrollTime: '09:00:00',
        expandRows: true,
        eventClick: async function(info) {
          const ev = info.event;
          const ext = ev.extendedProps || {};
          
          if (!currentUser) return;
          const isStudent = (currentUser.role === '学生' || String(currentUser.userId).startsWith('S'));
          
          if (isStudent && ext.canBook && ext.status === '可约') {
            const note = prompt(`预约备注（可填具体到达时间等）：\n${ev.title}  ${ev.start.toLocaleString('zh-CN')}`);
            const res = await callAPI('bookSlot', {
              slotId: ev.id,
              studentId: currentUser.userId,
              studentName: currentUser.name,
              note: note || ''
            });
            
            if (res && res.success) {
              alert('✅ 预约成功');
              loadCalendarEvents();
            } else {
              alert('❌ ' + (res.message || '预约失败'));
            }
          } else {
            showEventDetails(info.event);
          }
        }
      });

      mainCalendar.render();
      miniCalendar.render();

      const toolbar = mainCalendarEl.querySelector('.fc-toolbar');
      if (toolbar) toolbar.classList.add('show');

      loadCalendarEvents();
    }

    async function loadCalendarEvents() {
      if (!currentUser) return;
      try {
        const events = await callAPI('listVisibleSlots', { userId: currentUser.userId });
        if (mainCalendar) {
          mainCalendar.removeAllEvents();
          if (events && Array.isArray(events)) {
            events.forEach(ev => mainCalendar.addEvent(ev));
          }
        }
        if (miniCalendar) {
          miniCalendar.removeAllEvents();
          if (events && Array.isArray(events)) {
            events.forEach(ev => miniCalendar.addEvent(ev));
          }
        }
        updateTodayStats();
      } catch (e) {
        console.error('加载课程失败:', e);
      }
    }

    // ========== 数据加载 ==========
    function loadUserData() {
      if (!currentUser) return;
      if ((currentUser.role || '').toLowerCase() === '老师' || (currentUser.role || '').toLowerCase() === 'teacher') {
        loadDepartmentsList();
      }
      loadUserProfile();
    }

    function loadDepartmentsList() {
      const departments = ['文科大学院', '理科大学院'];
      const departmentSelect = document.getElementById('departmentSelect');
      if (departmentSelect) {
        departmentSelect.innerHTML = '<option value="">请选择所属部门</option>';
        departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = dept;
          departmentSelect.appendChild(option);
        });
      }
    }

    async function loadUserProfile() {
      const profileLoading = document.getElementById('profileLoading');
      const profileContent = document.getElementById('profileContent');
      
      if (profileLoading) profileLoading.style.display = 'block';
      if (profileContent) profileContent.style.display = 'none';
      
      try {
        const userInfo = await callAPI('getCurrentUserInfo', { userId: currentUser.userId });
        displayUserProfile(userInfo || currentUser || {});
        if (profileLoading) profileLoading.style.display = 'none';
        if (profileContent) profileContent.style.display = 'block';
      } catch (error) {
        console.error('加载用户信息失败:', error);
        if (profileLoading) profileLoading.style.display = 'none';
      }
    }

    // ========== 通用功能 ==========
    function refreshData() {
      if (currentUser) {
        loadCalendarEvents();
        updateTodayStats();
        
        // 同时检查连接状态
        connectionMonitor.checkConnection();
      }
    }

    function updateTodayStats() {
      // 简单的示例数据
      const todayCoursesEl = document.getElementById('todayCourses');
      const todayConsultationsEl = document.getElementById('todayConsultations');
      const todayRemindersEl = document.getElementById('todayReminders');
      const attendanceRateEl = document.getElementById('attendanceRate');
      
      if (todayCoursesEl) todayCoursesEl.textContent = '2';
      if (todayConsultationsEl) todayConsultationsEl.textContent = '1';
      if (todayRemindersEl) todayRemindersEl.textContent = '3';
      if (attendanceRateEl) attendanceRateEl.textContent = '95%';
    }

    function showEventDetails(event) {
      const details = [];
      details.push(`标题: ${event.title}`);
      details.push(`时间: ${event.start.toLocaleString('zh-CN')}`);
      if (event.end) details.push(`结束: ${event.end.toLocaleString('zh-CN')}`);
      if (event.extendedProps && event.extendedProps.description) {
        details.push(`描述: ${event.extendedProps.description}`);
      }
      alert(details.join('\n'));
    }

    function displayUserProfile(userInfo) {
      const info = userInfo || {};
      const basicInfo = document.getElementById('basicInfo');
      
      if (basicInfo) {
        basicInfo.innerHTML = `
          <div class="profile-item"><label>用户名:</label><span>${info.username || info.userId || ''}</span></div>
          <div class="profile-item"><label>姓名:</label><span>${info.name || ''}</span></div>
          <div class="profile-item"><label>所属:</label><span>${info.department || ''}</span></div>
          <div class="profile-item"><label>专业:</label><span>${info.major || ''}</span></div>
          <div class="profile-item"><label>身份:</label><span>${info.role || ''}</span></div>
        `;
      }
    }

    // ========== 🟢 页面初始化 ==========
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // 设置默认日期
        const now = new Date();
        const startMonthEl = document.getElementById('startMonth');
        const endMonthEl = document.getElementById('endMonth');
        if (startMonthEl) startMonthEl.value = now.toISOString().slice(0, 7);
        if (endMonthEl) endMonthEl.value = now.toISOString().slice(0, 7);

        // 绑定按钮事件
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('showRegisterBtn').addEventListener('click', showRegisterForm);
        document.getElementById('showLoginBtn').addEventListener('click', showLoginForm);

        // 🟢 新增：连接重试按钮
        document.getElementById('retryConnection').addEventListener('click', () => {
          connectionMonitor.retry();
        });

        // 🟢 新增：点击状态区域显示/隐藏详细信息
        document.getElementById('connectionStatus').addEventListener('click', () => {
          const detailsEl = document.getElementById('statusDetails');
          detailsEl.classList.toggle('show');
        });

        // 绑定导航标签
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.addEventListener('click', function() { 
            switchTab(this.dataset.tab); 
          });
        });

        // 绑定功能按钮
        const refreshBtn = document.getElementById('refreshDataBtn');
        if (refreshBtn) refreshBtn.addEventListener('click', refreshData);

        // 回车键直接登录
        document.getElementById('loginUsername').addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !this.disabled) login();
        });

        // 🟢 启动连接监控
        connectionMonitor.checkConnection();

        // 🟢 定期检查连接状态（每30秒）
        connectionCheckInterval = setInterval(() => {
          if (connectionMonitor.status === 'offline') {
            connectionMonitor.checkConnection();
          }
        }, 30000);

        console.log('✅ 页面初始化完成');

      } catch (error) {
        console.error('❌ 初始化失败:', error);
        alert('页面初始化失败: ' + error.message);
      }
    });

    // 🟢 页面卸载时清理定时器
    window.addEventListener('beforeunload', () => {
      if (connectionCheckInterval) {
        clearInterval(connectionCheckInterval);
      }
    });

    // ========== 简化的标签切换函数 ==========
    function switchTab(tabName) {
      // 这里可以添加标签切换逻辑
      console.log('切换到标签:', tabName);
    }
  </script>
</body>
</html>

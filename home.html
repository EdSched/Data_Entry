<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸ˆç”Ÿç®¡ç†å¹³å°</title>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js'></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #fff; color: #000; }

    /* ç™»å½•ç•Œé¢ */
    .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5f5; }
    .login-box { background: white; padding: 40px; border: 1px solid #ddd; border-radius: 8px; width: 350px; text-align: center; }
    .login-box h1 { margin-bottom: 20px; font-size: 24px; }
    
    /* ğŸŸ¢ æ–°å¢ï¼šè¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .connection-status { 
      margin-bottom: 20px; 
      padding: 10px; 
      border-radius: 6px; 
      font-size: 12px; 
      text-align: center;
      transition: all 0.3s ease;
    }
    .status-checking { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .status-online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    /* ğŸŸ¢ æ–°å¢ï¼šçŠ¶æ€æŒ‡ç¤ºç¯ */
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }
    .indicator-checking { background: #ffc107; }
    .indicator-online { background: #28a745; }
    .indicator-offline { background: #dc3545; }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* ğŸŸ¢ æ–°å¢ï¼šè¯¦ç»†çŠ¶æ€ä¿¡æ¯ */
    .status-details {
      font-size: 10px;
      margin-top: 5px;
      padding: 5px;
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
      display: none;
    }
    .status-details.show { display: block; }
    
    .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .login-box button { width: 100%; padding: 10px; background: #000; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; margin-top: 10px; transition: all 0.3s ease; }
    .login-box button:hover { background: #333; }
    .login-box button:disabled { background: #ccc; cursor: not-allowed; }
    
    /* ğŸŸ¢ æ–°å¢ï¼šç™»å½•è¿‡ç¨‹æŒ‡ç¤º */
    .login-progress {
      display: none;
      margin-top: 10px;
      padding: 8px;
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 4px;
      font-size: 12px;
    }
    .login-progress.show { display: block; }
    
    .progress-step {
      display: flex;
      align-items: center;
      margin: 3px 0;
      font-size: 11px;
    }
    .step-icon {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .step-pending { background: #ffc107; }
    .step-success { background: #28a745; }
    .step-error { background: #dc3545; }
    .step-loading {
      background: #007bff;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message { color: red; margin-top: 10px; font-size: 12px; }
    .success-message { color: green; margin-top: 10px; font-size: 12px; }
    .link-text { color: #007bff; cursor: pointer; text-decoration: underline; font-size: 12px; margin-top: 15px; }
    .link-text:hover { color: #0056b3; }

    /* ğŸŸ¢ æ–°å¢ï¼šé‡è¯•æŒ‰é’® */
    .retry-button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
      margin-top: 5px;
    }
    .retry-button:hover { background: #5a6268; }

    /* ä¸»ç•Œé¢ */
    .main-app { display: none; }

    /* é¡¶éƒ¨å¯¼èˆª */
    .header { background: #f5f5f5; padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 20px; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-info span { font-size: 14px; }
    .logout-btn { padding: 5px 10px; border: 1px solid #999; background: #fff; cursor: pointer; border-radius: 4px; font-size: 12px; }

    /* æ ‡ç­¾å¯¼èˆª */
    .nav-tabs { display: flex; border-bottom: 1px solid #ddd; background: #f9f9f9; }
    .nav-tab { padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; }
    .nav-tab.active { border-bottom-color: #000; background: #fff; }

    /* ä¸»è¦å¸ƒå±€ */
    .main-container { display: flex; height: calc(100vh - 120px); }
    .content-panel { flex: 1; padding: 20px; display: none; overflow-y: auto; display: flex;flex-direction: column;overflow: hidden; }
    .calendar-main {flex: 1;min-height: 0;display: flex;flex-direction: column;}
    #mainCalendar {flex: 1;min-height: 0;}
    .content-panel.active { display: block; }

    /* æ—¥å†å¸ƒå±€ */
    .calendar-layout { display: flex; gap: 20px; height: 100%; }
    .calendar-sidebar { width: 250px; border: 1px solid #ddd; padding: 15px; }
    .calendar-main { flex: 1; border: 1px solid #ddd; padding: 15px; }

    .sidebar-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .sidebar-section:last-child { border-bottom: none; }
    .sidebar-section h3 { margin-bottom: 10px; font-size: 14px; }

    /* ç»Ÿè®¡ç½‘æ ¼ */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .stat-item { text-align: center; padding: 8px; border: 1px solid #ddd; }
    .stat-number { font-size: 16px; font-weight: bold; }
    .stat-label { font-size: 11px; margin-top: 2px; }

    /* åŠŸèƒ½æŒ‰é’® */
    .function-buttons { display: flex; flex-direction: column; gap: 8px; }
    .function-btn { padding: 8px 12px; border: 1px solid #999; background: #f5f5f5; cursor: pointer; text-align: center; font-size: 12px; }
    .function-btn:hover { background: #eee; }

    /* æ•°æ®åˆ†æé¡µé¢ */
    .filter-panel { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; }
    .filter-section { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .filter-section:last-child { border-bottom: none; }
    .filter-section h3 { margin-bottom: 10px; font-size: 14px; }

    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .filter-item { display: flex; flex-direction: column; }
    .filter-item label { margin-bottom: 3px; font-size: 12px; }
    .filter-item select, .filter-item input { padding: 5px; border: 1px solid #999; font-size: 12px; }

    /* å­¦ç”Ÿåˆ—è¡¨ */
    .student-list { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    .student-item { display: flex; align-items: center; gap: 8px; padding: 5px; border-bottom: 1px solid #eee; }
    .student-item:last-child { border-bottom: none; }
    .student-item input { margin: 0; }
    .student-item label { margin: 0; cursor: pointer; font-size: 12px; flex: 1; }
    .student-item.selected { background: #f0f0f0; }

    /* æŒ‰é’®æ ·å¼ */
    .btn { padding: 8px 16px; border: 1px solid #999; background: #f5f5f5; cursor: pointer; font-size: 12px; }
    .btn:hover { background: #eee; }
    .btn-primary { background: #000; color: #fff; }
    .btn-primary:hover { background: #333; }

    .action-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }

    /* ç»“æœå±•ç¤º */
    .results-panel { border: 1px solid #ddd; margin-top: 20px; display: none; }
    .results-header { background: #f5f5f5; padding: 10px; border-bottom: 1px solid #ddd; }
    .results-content { padding: 15px; }

    .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    .data-table th, .data-table td { padding: 6px; border: 1px solid #ddd; text-align: left; font-size: 11px; }
    .data-table th { background: #f5f5f5; font-weight: bold; }

    .copy-area { background: #f9f9f9; border: 1px solid #ddd; padding: 10px; font-family: monospace; font-size: 10px; max-height: 200px; overflow-y: auto; margin-top: 10px; }

    /* ç”¨æˆ·è¯¦æƒ…é¡µé¢ */
    .user-profile { max-width: 600px; }
    .profile-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; }
    .profile-section h3 { margin-bottom: 10px; font-size: 14px; }
    .profile-item { display: flex; margin-bottom: 8px; }
    .profile-item label { min-width: 120px; font-weight: bold; font-size: 12px; }
    .profile-item span { font-size: 12px; }

    /* åŠ è½½åŠ¨ç”» */
    .loading { text-align: center; padding: 20px; }
    .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #999; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto 10px; }

    /* å°æ—¥å†æ ·å¼ */
    .mini-calendar .fc { font-size: 10px; }
    .mini-calendar .fc-button { padding: 2px 4px; font-size: 9px; }
    .mini-calendar .fc-daygrid-day { height: 20px; }
    .mini-calendar .fc-daygrid-day-number { font-size: 9px; }
    .mini-calendar .fc-event { font-size: 6px; height: 2px; }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .calendar-layout { flex-direction: column; }
      .calendar-sidebar { width: 100%; }
      .filter-grid { grid-template-columns: 1fr; }
    }

    /* éšè—FullCalendaré»˜è®¤å·¥å…·æ  */
    .fc-toolbar { display: none; }
    .fc-toolbar.show { display: flex; }
  </style>
</head>
<body>
  <!-- ç™»å½•ç•Œé¢ -->
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <h1>å¸ˆç”Ÿç®¡ç†å¹³å°</h1>

      <!-- ğŸŸ¢ æ–°å¢ï¼šè¿æ¥çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
      <div id="connectionStatus" class="connection-status status-checking">
        <span class="status-indicator indicator-checking"></span>
        <span id="statusText">æ­£åœ¨æ£€æµ‹æœåŠ¡å™¨è¿æ¥...</span>
        <div id="statusDetails" class="status-details">
          <div>æ­£åœ¨è¿æ¥åˆ°åå°æœåŠ¡...</div>
        </div>
        <button id="retryConnection" class="retry-button" style="display: none;">é‡è¯•è¿æ¥</button>
      </div>

      <!-- ç™»å½•è¡¨å• -->
      <div id="loginForm">
        <input type="text" id="loginUsername" placeholder="ç”¨æˆ·åï¼ˆç”±è€å¸ˆåˆ†é…ï¼‰" />
        <button type="button" id="loginBtn" disabled>ç™»å½•</button>
        
        <!-- ğŸŸ¢ æ–°å¢ï¼šç™»å½•è¿‡ç¨‹æŒ‡ç¤º -->
        <div id="loginProgress" class="login-progress">
          <div class="progress-step">
            <span id="stepVerify" class="step-icon step-pending"></span>
            <span>éªŒè¯ç”¨æˆ·å...</span>
          </div>
          <div class="progress-step">
            <span id="stepConnect" class="step-icon step-pending"></span>
            <span>è¿æ¥ç”¨æˆ·æ•°æ®...</span>
          </div>
          <div class="progress-step">
            <span id="stepLoad" class="step-icon step-pending"></span>
            <span>åŠ è½½ä¸ªäººä¿¡æ¯...</span>
          </div>
        </div>
        
        <div class="link-text" id="showRegisterBtn">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç™»è®°ä¿¡æ¯</div>
        <div id="loginError" class="error-message"></div>
      </div>

      <!-- æ³¨å†Œè¡¨å• -->
      <div id="registerForm" style="display: none;">
        <input type="text" id="registerName" placeholder="å§“å" />
        <input type="email" id="registerEmail" placeholder="é‚®ç®±ï¼ˆç”¨äºåŒºåˆ†åŒåï¼Œä¸å¯¹å¤–å…¬å¼€ï¼‰" />

        <select id="registerDepartment">
          <option value="">é€‰æ‹©æ‰€å±éƒ¨é—¨</option>
          <option value="æ–‡ç§‘å¤§å­¦é™¢">æ–‡ç§‘å¤§å­¦é™¢</option>
          <option value="ç†ç§‘å¤§å­¦é™¢">ç†ç§‘å¤§å­¦é™¢</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>

        <input type="text" id="registerMajor" placeholder="ä¸“ä¸š" />

        <select id="registerRole">
          <option value="">é€‰æ‹©èº«ä»½</option>
          <option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option>
          <option value="è€å¸ˆ">è€å¸ˆ</option>
        </select>

        <button type="button" id="registerBtn">ç™»è®°</button>

        <div class="link-text" id="showLoginBtn">å·²æœ‰è´¦å·ï¼Ÿè¿”å›ç™»å½•</div>
        <div id="registerError" class="error-message"></div>
      </div>
    </div>
  </div>

  <!-- ä¸»åº”ç”¨ç•Œé¢ï¼ˆä¿æŒä¸å˜ï¼‰ -->
  <div id="mainApp" class="main-app">
    <div class="header">
      <h1>å¸ˆç”Ÿç®¡ç†å¹³å°</h1>
      <div class="user-info">
        <span id="userGreeting">æ¬¢è¿ï¼Œ</span>
        <span id="userRole"></span>
        <button class="logout-btn" id="logoutBtn">é€€å‡º</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="calendar">æ—¥å†è§†å›¾</button>
      <button class="nav-tab" data-tab="analysis" id="analysisTab">æ•°æ®åˆ†æ</button>
      <button class="nav-tab" data-tab="profile">ä¸ªäººä¿¡æ¯</button>
    </div>

    <div class="main-container">
      <!-- æ—¥å†é¡µé¢ -->
      <div class="content-panel active" id="calendarPanel">
        <div class="calendar-layout">
          <div class="calendar-sidebar">
            <div class="sidebar-section">
              <h3>å°æ—¥å†</h3>
              <div id="miniCalendar" class="mini-calendar"></div>
            </div>

            <div class="sidebar-section">
              <h3>ä»Šæ—¥æ¦‚è§ˆ</h3>
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-number" id="todayCourses">0</div>
                  <div class="stat-label">è¯¾ç¨‹</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="todayConsultations">0</div>
                  <div class="stat-label">é¢è°ˆ</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="todayReminders">0</div>
                  <div class="stat-label">æé†’</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="attendanceRate">0%</div>
                  <div class="stat-label">å‡ºå‹¤ç‡</div>
                </div>
              </div>
            </div>

            <div class="sidebar-section">
              <div class="sidebar-section" id="publishPanel" style="display:none;">
                <h3>è€å¸ˆç™»è®°</h3>
                <div class="filter-item">
                  <label>è¯¾ç¨‹å±æ€§</label>
                  <select id="pubAttr">
                    <option value="å¤§è¯¾">å¤§è¯¾ï¼ˆåªè¯»ï¼‰</option>
                    <option value="VIP">VIPï¼ˆå¯çº¦ï¼‰</option>
                    <option value="é¢è°ˆ">é¢è°ˆï¼ˆå¯çº¦ï¼‰</option>
                  </select>
                </div>
                <div class="filter-item">
                  <label>è¯¾ç¨‹åï¼ˆå¤§è¯¾å¿…å¡«ï¼‰</label>
                  <input type="text" id="pubCourseName" />
                </div>
                <div class="filter-item">
                  <label>æ¨¡å¼</label>
                  <select id="pubMode">
                    <option value="single">å•æ¬¡</option>
                    <option value="range">åŒºé—´+å‘¨å‡ </option>
                  </select>
                </div>
                <div class="filter-item" id="singleDateRow">
                  <label>æ—¥æœŸ</label>
                  <input type="date" id="pubDate" />
                </div>
                <div class="filter-item" id="rangeRows" style="display:none;">
                  <label>èµ·æ­¢æ—¥æœŸ</label>
                  <div style="display:flex;gap:6px;">
                    <input type="date" id="pubStartDate" />
                    <input type="date" id="pubEndDate" />
                  </div>
                  <label style="margin-top:6px;">å‘¨å‡ ï¼ˆå¯å¤šé€‰ï¼‰</label>
                  <div>
                    <label><input type="checkbox" class="wd" value="1">å‘¨ä¸€</label>
                    <label><input type="checkbox" class="wd" value="2">å‘¨äºŒ</label>
                    <label><input type="checkbox" class="wd" value="3">å‘¨ä¸‰</label>
                    <label><input type="checkbox" class="wd" value="4">å‘¨å››</label>
                    <label><input type="checkbox" class="wd" value="5">å‘¨äº”</label>
                    <label><input type="checkbox" class="wd" value="6">å‘¨å…­</label>
                    <label><input type="checkbox" class="wd" value="0">å‘¨æ—¥</label>
                  </div>
                  <label style="margin-top:6px;">å›æ•°ï¼ˆå¯é€‰ï¼‰</label>
                  <input type="number" id="pubCount" min="1" placeholder="ä¸å¡«åˆ™æŒ‰åŒºé—´+å‘¨å‡ å…¨éƒ¨å±•å¼€" />
                </div>
                <div class="filter-item">
                  <label>æ—¶é—´ï¼ˆå¼€å§‹-ç»“æŸï¼‰</label>
                  <div style="display:flex;gap:6px;">
                    <input type="time" id="pubStartTime" value="09:00" />
                    <input type="time" id="pubEndTime" value="10:00" />
                  </div>
                  <div style="font-size:11px;color:#666;">ä»…å…è®¸æ•´ç‚¹æˆ–åŠç‚¹ï¼ˆ:00 / :30ï¼‰</div>
                </div>
                <div class="filter-item">
                  <label>é¢å‘ä¸“ä¸šï¼ˆé€—å·åˆ†éš”ï¼›ç©º=å…¨ä¸“ä¸šï¼‰</label>
                  <input type="text" id="pubMajors" placeholder="ä¾‹ï¼šæ–‡ç§‘ç ”ç©¶ç§‘,å·¥å­¦ç ”ç©¶ç§‘" />
                </div>
                <div class="filter-item">
                  <label>å¯è§å­¦ç”ŸIDsï¼ˆé€—å·åˆ†éš”ï¼›VIP/é¢è°ˆç”¨ï¼‰</label>
                  <input type="text" id="pubVisibleIds" placeholder="ä¾‹ï¼šS001,S015" />
                </div>
                <button class="btn btn-primary" id="pubSubmitBtn">å‘å¸ƒ</button>
              </div>

              <div class="function-buttons">
                <button class="function-btn" id="refreshDataBtn">åˆ·æ–°æ•°æ®</button>
                <button class="function-btn" id="analysisBtn">æ•°æ®åˆ†æ</button>
                <button class="function-btn" id="profileBtn">ä¸ªäººä¿¡æ¯</button>
                <button class="function-btn" id="helpBtn">ä½¿ç”¨å¸®åŠ©</button>
              </div>
            </div>
          </div>

          <div class="calendar-main">
            <div id="mainCalendar"></div>
          </div>
        </div>
      </div>

      <!-- å…¶ä»–é¡µé¢ä¿æŒä¸å˜... -->
      <div class="content-panel" id="analysisPanel">
        <!-- æ•°æ®åˆ†æé¡µé¢å†…å®¹ -->
      </div>

      <div class="content-panel" id="profilePanel">
        <!-- ä¸ªäººä¿¡æ¯é¡µé¢å†…å®¹ -->
      </div>
    </div>
  </div>

  <script>
    // ========== å…¨å±€å˜é‡ ==========
    const API_URL = 'https://script.google.com/macros/s/AKfycbxJw_3N3fDwCOzgixIXXgSahTho-s-H_M8-hdQhDK09vSxp6-WgX6CztXbVph1vemmq/exec';
    let currentUser = null;
    let allStudents = [];
    let selectedStudents = [];
    let mainCalendar, miniCalendar;
    let connectionCheckInterval;

    // ========== ğŸŸ¢ æ–°å¢ï¼šè¿æ¥çŠ¶æ€ç®¡ç† ==========
    class ConnectionMonitor {
      constructor() {
        this.status = 'checking';
        this.lastCheck = null;
        this.retryCount = 0;
        this.maxRetries = 3;
      }

      async checkConnection() {
        this.updateStatus('checking', 'æ­£åœ¨æ£€æµ‹æœåŠ¡å™¨è¿æ¥...');
        
        try {
          const startTime = Date.now();
          const result = await this.callAPIWithTimeout('testConnection', {}, 10000);
          const responseTime = Date.now() - startTime;
          
          if (result && result.success) {
            this.updateStatus('online', 'âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸', {
              userCount: result.userCount || 0,
              responseTime: responseTime,
              spreadsheetName: result.spreadsheetName,
              timestamp: result.timestamp
            });
            this.retryCount = 0;
            this.enableLogin();
          } else {
            throw new Error(result?.message || 'æœåŠ¡å™¨å“åº”å¼‚å¸¸');
          }
        } catch (error) {
          this.retryCount++;
          console.error('è¿æ¥æ£€æµ‹å¤±è´¥:', error);
          
          if (this.retryCount < this.maxRetries) {
            this.updateStatus('error', `âŒ è¿æ¥å¤±è´¥ï¼Œæ­£åœ¨é‡è¯• (${this.retryCount}/${this.maxRetries})...`, {
              error: error.message,
              retrying: true
            });
            setTimeout(() => this.checkConnection(), 2000);
          } else {
            this.updateStatus('offline', 'âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥', {
              error: error.message,
              canRetry: true
            });
            this.showRetryButton();
          }
        }
      }

      async callAPIWithTimeout(action, params, timeout) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
          const formData = new URLSearchParams();
          formData.append('action', action);
          formData.append('params', JSON.stringify(params));

          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData,
            mode: 'cors',
            signal: controller.signal
          });

          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const text = await response.text();
          let cleanText = text.trim();
          const jsonStart = cleanText.indexOf('{');
          const jsonEnd = cleanText.lastIndexOf('}');
          
          if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
            cleanText = cleanText.substring(jsonStart, jsonEnd + 1);
          }
          
          return JSON.parse(cleanText);
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
          }
          throw error;
        }
      }

      updateStatus(status, message, details = {}) {
        this.status = status;
        this.lastCheck = new Date();
        
        const statusEl = document.getElementById('connectionStatus');
        const textEl = document.getElementById('statusText');
        const detailsEl = document.getElementById('statusDetails');
        const indicatorEl = statusEl.querySelector('.status-indicator');

        // æ›´æ–°çŠ¶æ€æ ·å¼
        statusEl.className = `connection-status status-${status}`;
        indicatorEl.className = `status-indicator indicator-${status}`;
        textEl.textContent = message;

        // æ›´æ–°è¯¦ç»†ä¿¡æ¯
        if (details && Object.keys(details).length > 0) {
          let detailsHTML = '';
          
          if (details.spreadsheetName) {
            detailsHTML += `<div>ğŸ“Š è¡¨æ ¼: ${details.spreadsheetName}</div>`;
          }
          if (details.userCount !== undefined) {
            detailsHTML += `<div>ğŸ‘¥ ç”¨æˆ·æ•°: ${details.userCount}</div>`;
          }
          if (details.responseTime) {
            detailsHTML += `<div>âš¡ å“åº”æ—¶é—´: ${details.responseTime}ms</div>`;
          }
          if (details.timestamp) {
            detailsHTML += `<div>ğŸ• æ£€æµ‹æ—¶é—´: ${new Date(details.timestamp).toLocaleString()}</div>`;
          }
          if (details.error) {
            detailsHTML += `<div>âŒ é”™è¯¯: ${details.error}</div>`;
          }
          
          if (detailsHTML) {
            detailsEl.innerHTML = detailsHTML;
            detailsEl.classList.add('show');
          }
        } else {
          detailsEl.classList.remove('show');
        }
      }

      enableLogin() {
        const loginBtn = document.getElementById('loginBtn');
        loginBtn.disabled = false;
        loginBtn.textContent = 'ç™»å½•';
      }

      disableLogin() {
        const loginBtn = document.getElementById('loginBtn');
        loginBtn.disabled = true;
        loginBtn.textContent = 'æœåŠ¡å™¨ç¦»çº¿';
      }

      showRetryButton() {
        const retryBtn = document.getElementById('retryConnection');
        retryBtn.style.display = 'inline-block';
        this.disableLogin();
      }

      hideRetryButton() {
        const retryBtn = document.getElementById('retryConnection');
        retryBtn.style.display = 'none';
      }

      retry() {
        this.retryCount = 0;
        this.hideRetryButton();
        this.checkConnection();
      }
    }

    // åˆ›å»ºè¿æ¥ç›‘æ§å®ä¾‹
    const connectionMonitor = new ConnectionMonitor();

    // ========== ğŸŸ¢ æ–°å¢ï¼šå¢å¼ºçš„APIè°ƒç”¨å‡½æ•° ==========
    async function callAPI(action, params = {}) {
      try {
        return await connectionMonitor.callAPIWithTimeout(action, params, 15000);
      } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
        return { success: false, message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message };
      }
    }

    // ========== ğŸŸ¢ æ–°å¢ï¼šç™»å½•è¿‡ç¨‹å¯è§†åŒ– ==========
    function showLoginProgress() {
      const progressEl = document.getElementById('loginProgress');
      progressEl.classList.add('show');
      
      // é‡ç½®æ‰€æœ‰æ­¥éª¤
      document.getElementById('stepVerify').className = 'step-icon step-pending';
      document.getElementById('stepConnect').className = 'step-icon step-pending';
      document.getElementById('stepLoad').className = 'step-icon step-pending';
    }

    function updateLoginStep(step, status) {
      const stepEl = document.getElementById(`step${step}`);
      stepEl.className = `step-icon step-${status}`;
    }

    function hideLoginProgress() {
      const progressEl = document.getElementById('loginProgress');
      progressEl.classList.remove('show');
    }

    // ========== ç•Œé¢åˆ‡æ¢ ==========
    function showRegisterForm() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
      clearMessages();
    }

    function showLoginForm() {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      clearMessages();
    }

    function clearMessages() {
      document.getElementById('loginError').textContent = '';
      document.getElementById('registerError').textContent = '';
      hideLoginProgress();
    }

    // ========== ğŸŸ¢ å¢å¼ºçš„ç™»å½•å‡½æ•° ==========
    async function login() {
      const username = (document.getElementById('loginUsername').value || '').trim();
      const errorDiv = document.getElementById('loginError');

      if (!username) {
        errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·å';
        return;
      }

      // æ£€æŸ¥è¿æ¥çŠ¶æ€
      if (connectionMonitor.status !== 'online') {
        errorDiv.textContent = 'æœåŠ¡å™¨è¿æ¥å¼‚å¸¸ï¼Œè¯·ç­‰å¾…è¿æ¥æ¢å¤åé‡è¯•';
        return;
      }

      // æ˜¾ç¤ºç™»å½•è¿‡ç¨‹
      showLoginProgress();
      errorDiv.textContent = '';
      
      // ç¦ç”¨ç™»å½•æŒ‰é’®
      const loginBtn = document.getElementById('loginBtn');
      loginBtn.disabled = true;
      loginBtn.textContent = 'ç™»å½•ä¸­...';

      try {
        // æ­¥éª¤1ï¼šéªŒè¯ç”¨æˆ·å
        updateLoginStep('Verify', 'loading');
        await new Promise(resolve => setTimeout(resolve, 500)); // è§†è§‰æ•ˆæœ

        const result = await callAPI('loginByUsername', { username });

        if (!result || !result.success) {
          updateLoginStep('Verify', 'error');
          throw new Error((result && result.message) || 'ç”¨æˆ·åä¸å­˜åœ¨');
        }

        updateLoginStep('Verify', 'success');

        // æ­¥éª¤2ï¼šè¿æ¥ç”¨æˆ·æ•°æ®
        updateLoginStep('Connect', 'loading');
        await new Promise(resolve => setTimeout(resolve, 300));

        currentUser = result.user || {};
        currentUser.userId = currentUser.username || username;

        updateLoginStep('Connect', 'success');

        // æ­¥éª¤3ï¼šåŠ è½½ä¸ªäººä¿¡æ¯
        updateLoginStep('Load', 'loading');
        await new Promise(resolve => setTimeout(resolve, 300));

        // è¿›å…¥ä¸»åº”ç”¨
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';

        updateLoginStep('Load', 'success');

        // åˆå§‹åŒ–åº”ç”¨
        updateUserInterface();
        initializeCalendars();
        loadUserData();

        hideLoginProgress();

      } catch (error) {
        console.error('ç™»å½•å¤±è´¥:', error);
        errorDiv.textContent = error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
        hideLoginProgress();
      } finally {
        // æ¢å¤ç™»å½•æŒ‰é’®
        loginBtn.disabled = false;
        loginBtn.textContent = 'ç™»å½•';
      }
    }

    // ========== ğŸŸ¢ å¢å¼ºçš„æ³¨å†Œå‡½æ•° ==========
    async function register() {
      const name = (document.getElementById('registerName').value || '').trim();
      const email = (document.getElementById('registerEmail').value || '').trim();
      const department = document.getElementById('registerDepartment').value;
      const major = (document.getElementById('registerMajor').value || '').trim();
      const role = document.getElementById('registerRole').value;
      const errorDiv = document.getElementById('registerError');

      if (!name || !email || !department || !major || !role) {
        errorDiv.textContent = 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ';
        return;
      }

      // æ£€æŸ¥è¿æ¥çŠ¶æ€
      if (connectionMonitor.status !== 'online') {
        errorDiv.textContent = 'æœåŠ¡å™¨è¿æ¥å¼‚å¸¸ï¼Œè¯·ç­‰å¾…è¿æ¥æ¢å¤åé‡è¯•';
        return;
      }

      const registerBtn = document.getElementById('registerBtn');
      registerBtn.disabled = true;
      registerBtn.textContent = 'ç™»è®°ä¸­...';
      errorDiv.textContent = 'æ­£åœ¨æäº¤ç™»è®°ä¿¡æ¯...';
      errorDiv.style.color = '#007bff';

      try {
        const result = await callAPI('registerByProfile', { name, email, department, major, role });

        if (result && result.success) {
          errorDiv.style.color = 'green';
          errorDiv.textContent = 'âœ… ç™»è®°æˆåŠŸï¼è¯·è”ç³»è€å¸ˆè·å–æ‚¨çš„"ç”¨æˆ·å"ï¼Œä¹‹åä½¿ç”¨ç”¨æˆ·åç™»å½•ã€‚';

          // æ¸…ç©ºæ³¨å†Œè¡¨å•
          document.getElementById('registerName').value = '';
          document.getElementById('registerEmail').value = '';
          document.getElementById('registerDepartment').value = '';
          document.getElementById('registerMajor').value = '';
          document.getElementById('registerRole').value = '';

          // 3ç§’åå›åˆ°ç™»å½•
          setTimeout(() => {
            showLoginForm();
          }, 3000);
        } else {
          throw new Error((result && result.message) || 'ç™»è®°å¤±è´¥');
        }
      } catch (error) {
        console.error('æ³¨å†Œå¤±è´¥:', error);
        errorDiv.style.color = 'red';
        errorDiv.textContent = 'âŒ ' + error.message;
      } finally {
        registerBtn.disabled = false;
        registerBtn.textContent = 'ç™»è®°';
      }
    }

    // ========== é€€å‡ºç™»å½• ==========
    function logout() {
      currentUser = null;
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('loginUsername').value = '';
      clearMessages();
      
      // é‡æ–°æ£€æŸ¥è¿æ¥çŠ¶æ€
      connectionMonitor.checkConnection();
    }

    // ========== ç”¨æˆ·ç•Œé¢æ›´æ–° ==========
    function updateUserInterface() {
      if (!currentUser) return;
      document.getElementById('userGreeting').textContent = `æ¬¢è¿ï¼Œ${currentUser.name}`;
      document.getElementById('userRole').textContent = `(${currentUser.role})`;

      const analysisTab = document.getElementById('analysisTab');
      const analysisBtn = document.getElementById('analysisBtn');
      const isTeacher = (currentUser.role === 'è€å¸ˆ' || String(currentUser.userId).startsWith('T'));
      const isAdmin = String(currentUser.userId).startsWith('A');

      if (isTeacher || isAdmin) {
        analysisTab.style.display = 'block';
        analysisBtn.style.display = 'block';
        document.getElementById('publishPanel').style.display = 'block';
      } else {
        analysisTab.style.display = 'none';
        analysisBtn.style.display = 'none';
        document.getElementById('publishPanel').style.display = 'none';
      }
    }

    // ========== æ—¥å†ç›¸å…³ ==========
    function initializeCalendars() {
      const miniCalendarEl = document.getElementById('miniCalendar');
      miniCalendar = new FullCalendar.Calendar(miniCalendarEl, {
        initialView: 'dayGridMonth',
        locale: 'zh-cn',
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        height: 'auto',
        events: [],
        slotMinTime: '09:00:00',
        slotMaxTime: '21:00:00',
        expandRows: true,
        dateClick: function(info) { 
          if (mainCalendar) mainCalendar.gotoDate(info.dateStr); 
        }
      });

      const mainCalendarEl = document.getElementById('mainCalendar');
      mainCalendar = new FullCalendar.Calendar(mainCalendarEl, {
        initialView: 'timeGridWeek',
        locale: 'zh-cn',
        headerToolbar: { left: 'prev,next', center: 'title', right: 'today,timeGridWeek,timeGridDay' },
        buttonText: { today: 'ä»Šå¤©', week: 'å‘¨', day: 'æ—¥' },
        height: 'auto',
        events: [],
        allDaySlot: false,
        slotMinTime: '09:00:00',
        slotMaxTime: '21:00:00',
        slotDuration: '00:30:00',
        slotLabelInterval: '01:00:00',
        scrollTime: '09:00:00',
        expandRows: true,
        eventClick: async function(info) {
          const ev = info.event;
          const ext = ev.extendedProps || {};
          
          if (!currentUser) return;
          const isStudent = (currentUser.role === 'å­¦ç”Ÿ' || String(currentUser.userId).startsWith('S'));
          
          if (isStudent && ext.canBook && ext.status === 'å¯çº¦') {
            const note = prompt(`é¢„çº¦å¤‡æ³¨ï¼ˆå¯å¡«å…·ä½“åˆ°è¾¾æ—¶é—´ç­‰ï¼‰ï¼š\n${ev.title}  ${ev.start.toLocaleString('zh-CN')}`);
            const res = await callAPI('bookSlot', {
              slotId: ev.id,
              studentId: currentUser.userId,
              studentName: currentUser.name,
              note: note || ''
            });
            
            if (res && res.success) {
              alert('âœ… é¢„çº¦æˆåŠŸ');
              loadCalendarEvents();
            } else {
              alert('âŒ ' + (res.message || 'é¢„çº¦å¤±è´¥'));
            }
          } else {
            showEventDetails(info.event);
          }
        }
      });

      mainCalendar.render();
      miniCalendar.render();

      const toolbar = mainCalendarEl.querySelector('.fc-toolbar');
      if (toolbar) toolbar.classList.add('show');

      loadCalendarEvents();
    }

    async function loadCalendarEvents() {
      if (!currentUser) return;
      try {
        const events = await callAPI('listVisibleSlots', { userId: currentUser.userId });
        if (mainCalendar) {
          mainCalendar.removeAllEvents();
          if (events && Array.isArray(events)) {
            events.forEach(ev => mainCalendar.addEvent(ev));
          }
        }
        if (miniCalendar) {
          miniCalendar.removeAllEvents();
          if (events && Array.isArray(events)) {
            events.forEach(ev => miniCalendar.addEvent(ev));
          }
        }
        updateTodayStats();
      } catch (e) {
        console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', e);
      }
    }

    // ========== æ•°æ®åŠ è½½ ==========
    function loadUserData() {
      if (!currentUser) return;
      if ((currentUser.role || '').toLowerCase() === 'è€å¸ˆ' || (currentUser.role || '').toLowerCase() === 'teacher') {
        loadDepartmentsList();
      }
      loadUserProfile();
    }

    function loadDepartmentsList() {
      const departments = ['æ–‡ç§‘å¤§å­¦é™¢', 'ç†ç§‘å¤§å­¦é™¢'];
      const departmentSelect = document.getElementById('departmentSelect');
      if (departmentSelect) {
        departmentSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ‰€å±éƒ¨é—¨</option>';
        departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = dept;
          departmentSelect.appendChild(option);
        });
      }
    }

    async function loadUserProfile() {
      const profileLoading = document.getElementById('profileLoading');
      const profileContent = document.getElementById('profileContent');
      
      if (profileLoading) profileLoading.style.display = 'block';
      if (profileContent) profileContent.style.display = 'none';
      
      try {
        const userInfo = await callAPI('getCurrentUserInfo', { userId: currentUser.userId });
        displayUserProfile(userInfo || currentUser || {});
        if (profileLoading) profileLoading.style.display = 'none';
        if (profileContent) profileContent.style.display = 'block';
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        if (profileLoading) profileLoading.style.display = 'none';
      }
    }

    // ========== é€šç”¨åŠŸèƒ½ ==========
    function refreshData() {
      if (currentUser) {
        loadCalendarEvents();
        updateTodayStats();
        
        // åŒæ—¶æ£€æŸ¥è¿æ¥çŠ¶æ€
        connectionMonitor.checkConnection();
      }
    }

    function updateTodayStats() {
      // ç®€å•çš„ç¤ºä¾‹æ•°æ®
      const todayCoursesEl = document.getElementById('todayCourses');
      const todayConsultationsEl = document.getElementById('todayConsultations');
      const todayRemindersEl = document.getElementById('todayReminders');
      const attendanceRateEl = document.getElementById('attendanceRate');
      
      if (todayCoursesEl) todayCoursesEl.textContent = '2';
      if (todayConsultationsEl) todayConsultationsEl.textContent = '1';
      if (todayRemindersEl) todayRemindersEl.textContent = '3';
      if (attendanceRateEl) attendanceRateEl.textContent = '95%';
    }

    function showEventDetails(event) {
      const details = [];
      details.push(`æ ‡é¢˜: ${event.title}`);
      details.push(`æ—¶é—´: ${event.start.toLocaleString('zh-CN')}`);
      if (event.end) details.push(`ç»“æŸ: ${event.end.toLocaleString('zh-CN')}`);
      if (event.extendedProps && event.extendedProps.description) {
        details.push(`æè¿°: ${event.extendedProps.description}`);
      }
      alert(details.join('\n'));
    }

    function displayUserProfile(userInfo) {
      const info = userInfo || {};
      const basicInfo = document.getElementById('basicInfo');
      
      if (basicInfo) {
        basicInfo.innerHTML = `
          <div class="profile-item"><label>ç”¨æˆ·å:</label><span>${info.username || info.userId || ''}</span></div>
          <div class="profile-item"><label>å§“å:</label><span>${info.name || ''}</span></div>
          <div class="profile-item"><label>æ‰€å±:</label><span>${info.department || ''}</span></div>
          <div class="profile-item"><label>ä¸“ä¸š:</label><span>${info.major || ''}</span></div>
          <div class="profile-item"><label>èº«ä»½:</label><span>${info.role || ''}</span></div>
        `;
      }
    }

    // ========== ğŸŸ¢ é¡µé¢åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        const now = new Date();
        const startMonthEl = document.getElementById('startMonth');
        const endMonthEl = document.getElementById('endMonth');
        if (startMonthEl) startMonthEl.value = now.toISOString().slice(0, 7);
        if (endMonthEl) endMonthEl.value = now.toISOString().slice(0, 7);

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('showRegisterBtn').addEventListener('click', showRegisterForm);
        document.getElementById('showLoginBtn').addEventListener('click', showLoginForm);

        // ğŸŸ¢ æ–°å¢ï¼šè¿æ¥é‡è¯•æŒ‰é’®
        document.getElementById('retryConnection').addEventListener('click', () => {
          connectionMonitor.retry();
        });

        // ğŸŸ¢ æ–°å¢ï¼šç‚¹å‡»çŠ¶æ€åŒºåŸŸæ˜¾ç¤º/éšè—è¯¦ç»†ä¿¡æ¯
        document.getElementById('connectionStatus').addEventListener('click', () => {
          const detailsEl = document.getElementById('statusDetails');
          detailsEl.classList.toggle('show');
        });

        // ç»‘å®šå¯¼èˆªæ ‡ç­¾
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.addEventListener('click', function() { 
            switchTab(this.dataset.tab); 
          });
        });

        // ç»‘å®šåŠŸèƒ½æŒ‰é’®
        const refreshBtn = document.getElementById('refreshDataBtn');
        if (refreshBtn) refreshBtn.addEventListener('click', refreshData);

        // å›è½¦é”®ç›´æ¥ç™»å½•
        document.getElementById('loginUsername').addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !this.disabled) login();
        });

        // ğŸŸ¢ å¯åŠ¨è¿æ¥ç›‘æ§
        connectionMonitor.checkConnection();

        // ğŸŸ¢ å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
        connectionCheckInterval = setInterval(() => {
          if (connectionMonitor.status === 'offline') {
            connectionMonitor.checkConnection();
          }
        }, 30000);

        console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');

      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
        alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
      }
    });

    // ğŸŸ¢ é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', () => {
      if (connectionCheckInterval) {
        clearInterval(connectionCheckInterval);
      }
    });

    // ========== ç®€åŒ–çš„æ ‡ç­¾åˆ‡æ¢å‡½æ•° ==========
    function switchTab(tabName) {
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ ‡ç­¾åˆ‡æ¢é€»è¾‘
      console.log('åˆ‡æ¢åˆ°æ ‡ç­¾:', tabName);
    }
  </script>
</body>
</html>
